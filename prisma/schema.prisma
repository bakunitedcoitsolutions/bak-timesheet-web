// Prisma Schema for Timesheet Management System
// Database: Supabase PostgreSQL

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================
// Note: Account and Session models are not needed since we're using:
// - CredentialsProvider (email/password) - no Account model needed
// - JWT session strategy - no Session model needed
// If you want to add OAuth providers (Google, GitHub, etc.) in the future,
// you'll need to add back the Account model.

model User {
  id            Int       @id @default(autoincrement())
  nameEn        String
  nameAr        String?
  email         String    @unique
  password      String?   // Hashed password
  userRoleId    Int
  branchId      Int?      // Required for Branch Manager (roleId: 3), optional for others
  isActive      Boolean   @default(true)
  createdBy     Int?      // ID of user who created this record
  updatedBy     Int?      // ID of user who last updated this record
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations: User → Other Tables (User has foreign keys)
  userRole      UserRole  @relation(fields: [userRoleId], references: [id])
  branch        Branch?   @relation(fields: [branchId], references: [id])
  privileges    UserPrivilege?
  creator       User?     @relation("UserCreatedBy", fields: [createdBy], references: [id])
  updater       User?     @relation("UserUpdatedBy", fields: [updatedBy], references: [id])
  
  // Relations: Other Tables → User (Other tables have foreign keys pointing to User)
  createdUsers  User[]    @relation("UserCreatedBy")
  updatedUsers  User[]    @relation("UserUpdatedBy")

  @@index([email])
  @@index([userRoleId])
  @@index([branchId])
  @@index([createdBy])
  @@index([updatedBy])
}

// ============================================
// USER ROLES & PERMISSIONS
// ============================================

model UserRole {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  access    String   // Admin, Manager, Branch Manager, Access-Enabled User
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
}

model UserPrivilege {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique
  privileges Json     // Stores UserPrivileges structure
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations: UserPrivilege → Other Tables (UserPrivilege has foreign keys)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// BRANCHES & LOCATIONS
// ============================================

model Branch {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations: Other Tables → Branch (Other tables have foreign keys pointing to Branch)
  users     User[]
  employees Employee[]
  projects  Project[]
}

model City {
  id            Int      @id @default(autoincrement())
  nameEn        String
  nameAr        String?
  countryId     Int?
  isActive      Boolean  @default(true)
  showInPayroll Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations: City → Other Tables (City has foreign keys)
  country   Country? @relation(fields: [countryId], references: [id])
  
  // Relations: Other Tables → City (Other tables have foreign keys pointing to City)
  employees Employee[]
}

model Country {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations: Other Tables → Country (Other tables have foreign keys pointing to Country)
  cities    City[]
  employees Employee[]
}

model GosiCity {
  id        Int       @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employees Employee[]
}

// ============================================
// EMPLOYEES
// ============================================

model Employee {
  // Step 1
  id                Int       @id @default(autoincrement())
  profilePicture    String?
  employeeCode      String?   @unique
  nameEn            String
  nameAr            String?
  dob         DateTime?
  phone             String?

  // Step 2
  gender            String?   // Male, Female
  countryId         Int?
  cityId            Int?
  statusId          Int?
  branchId          Int?
  designationId     Int?
  payrollSectionId  Int?
  isDeductable      Boolean   @default(false)
  isFixed           Boolean   @default(false)
  workingDays       Int?
  workingHours      Int?
  hourlyRate        Decimal?  @db.Decimal(10, 1)
  salary            Decimal?  @db.Decimal(10, 1)
  foodAllowance     Decimal?  @db.Decimal(10, 1)
  mobileAllowance   Decimal?  @db.Decimal(10, 1)
  otherAllowance    Decimal?  @db.Decimal(10, 1)
  contractStartDate DateTime?
  contractEndDate   DateTime?
  contractDocument  String?
  contractEndReason String?   @db.Text
  joiningDate       DateTime?

  // Step 3
  idCardNo          String?
  idCardExpiryDate DateTime?
  idCardDocument   String?
  profession       String?
  nationality      String?
  passportNo       String?
  passportExpiryDate DateTime?
  passportDocument String?

  // Step 4
  bankName          String?
  bankCode          String?
  iban              String?
  gosiSalary        Decimal?  @db.Decimal(10, 1)
  gosiCityId        Int?

  // Step 5 - Loan & Bank Card Details
  openingBalance    Decimal?  @db.Decimal(10, 1)
  isCardDelivered   Boolean   @default(false)
  cardDocument      String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime @updatedAt

  // Relations: Employee → Other Tables (Employee has foreign keys)
  country           Country?  @relation(fields: [countryId], references: [id])
  city              City?     @relation(fields: [cityId], references: [id])
  status            EmployeeStatus? @relation(fields: [statusId], references: [id])
  branch            Branch?   @relation(fields: [branchId], references: [id])
  designation       Designation? @relation(fields: [designationId], references: [id])
  payrollSection    PayrollSection? @relation(fields: [payrollSectionId], references: [id])
  gosiCity          GosiCity? @relation(fields: [gosiCityId], references: [id])
  
  // Relations: Other Tables → Employee (Other tables have foreign keys pointing to Employee)
  timesheets        Timesheet[]
  loans             Loan[]
  trafficChallans   TrafficChallan[]
  exitReentries     ExitReentry[]
  payrolls          Payroll[]
  ledgers           Ledger[]

  @@index([employeeCode])
  @@index([countryId])
  @@index([branchId])
  @@index([statusId])
}

model Designation {
  id                Int       @id @default(autoincrement())
  nameEn            String
  nameAr            String?
  hoursPerDay       Int?
  displayOrderKey   Int?
  color             String?   // Hex color code (e.g., #3B82F6)
  breakfastAllowance Decimal? @db.Decimal(10, 1)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations: Other Tables → Designation (Other tables have foreign keys pointing to Designation)
  employees Employee[]
  exitReentries ExitReentry[]
}

model EmployeeStatus {
  id        Int       @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations: Other Tables → EmployeeStatus (Other tables have foreign keys pointing to EmployeeStatus)
  employees Employee[]
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id          Int      @id @default(autoincrement())
  nameEn      String
  nameAr      String?
  branchId    Int?
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations: Project → Other Tables (Project has foreign keys)
  branch      Branch?  @relation(fields: [branchId], references: [id])
  
  // Relations: Other Tables → Project (Other tables have foreign keys pointing to Project)
  timesheetsAsProject1  Timesheet[] @relation("TimesheetProject1")
  timesheetsAsProject2  Timesheet[] @relation("TimesheetProject2")
}

// ============================================
// TIMESHEETS
// ============================================

model Timesheet {
  id                Int       @id @default(autoincrement())
  employeeId        Int
  date              DateTime  // Compulsory date field
  project1Id         Int?
  project1BfAllowance Boolean @default(false)
  project1Hours     Int?
  project1Overtime  Int?
  project2Id         Int?
  project2BfAllowance Boolean @default(false)
  project2Hours     Int?
  project2Overtime  Int?
  totalHours        Int?
  description       String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations: Timesheet → Other Tables (Timesheet has foreign keys)
  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  project1          Project?  @relation("TimesheetProject1", fields: [project1Id], references: [id], onDelete: Cascade)
  project2          Project?  @relation("TimesheetProject2", fields: [project2Id], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([date])
  @@index([project1Id])
  @@index([project2Id])
}

// ============================================
// PAYROLL
// ============================================

model Payroll {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  sectionId   Int?
  month       Int       // 1-12
  year        Int
  amount      Decimal   @db.Decimal(10, 2)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations: Payroll → Other Tables (Payroll has foreign keys)
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  section     PayrollSection? @relation(fields: [sectionId], references: [id])

  @@index([employeeId])
  @@index([year, month])
}

model PayrollSection {
  id             Int      @id @default(autoincrement())
  nameEn         String
  nameAr         String?
  displayOrderKey Int?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations: Other Tables → PayrollSection (Other tables have foreign keys pointing to PayrollSection)
  employees Employee[]
  payrolls  Payroll[]
}

// ============================================
// LOANS
// ============================================

enum LoanType {
  LOAN
  RETURN
}

model Loan {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  date        DateTime
  type        LoanType
  amount      Decimal   @db.Decimal(10, 2)
  remarks     String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations: Loan → Other Tables (Loan has foreign keys)
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([date])
  @@index([type])
}

// ============================================
// TRAFFIC CHALLANS
// ============================================

enum TrafficChallanType {
  CHALLAN
  RETURN
}

model TrafficChallan {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  date        DateTime
  type        TrafficChallanType
  amount      Decimal   @db.Decimal(10, 2)
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations: TrafficChallan → Other Tables (TrafficChallan has foreign keys)
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([date])
  @@index([type])
}

// ============================================
// EXIT & RE-ENTRY
// ============================================

enum ExitReentryType {
  EXIT
  ENTRY
}

model ExitReentry {
  id            Int       @id @default(autoincrement())
  employeeId    Int
  designationId Int?
  date          DateTime
  type          ExitReentryType
  remarks       String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations: ExitReentry → Other Tables (ExitReentry has foreign keys)
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  designation   Designation? @relation(fields: [designationId], references: [id])

  @@index([employeeId])
  @@index([designationId])
  @@index([date])
  @@index([type])
}

// ============================================
// LEDGER
// ============================================

enum LedgerType {
  SALARY
  LOAN
  CHALLAN
}

enum AmountType {
  CREDIT
  DEBIT
}

model Ledger {
  id          Int       @id @default(autoincrement())
  employeeId  Int?
  date        DateTime
  type        LedgerType
  amountType  AmountType
  amount      Decimal   @db.Decimal(10, 2)
  balance     Decimal   @db.Decimal(10, 2)
  description String    @db.Text
  reference   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations: Ledger → Other Tables (Ledger has foreign keys)
  employee    Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([employeeId])
  @@index([type])
  @@index([amountType])
}
