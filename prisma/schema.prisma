// Prisma Schema for Timesheet Management System
// Database: Supabase PostgreSQL

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================
// Note: Account and Session models are not needed since we're using:
// - CredentialsProvider (email/password) - no Account model needed
// - JWT session strategy - no Session model needed
// If you want to add OAuth providers (Google, GitHub, etc.) in the future,
// you'll need to add back the Account model.

model User {
  id            String    @id @default(cuid())
  nameEn        String
  nameAr        String?
  email         String    @unique
  password      String?   // Hashed password
  image         String?
  userRoleId    Int
  branchId      Int?      // Required for Branch Manager (roleId: 3), optional for others
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  userRole      UserRole  @relation(fields: [userRoleId], references: [id])
  branch        Branch?   @relation(fields: [branchId], references: [id])
  privileges    UserPrivilege?

  @@index([email])
  @@index([userRoleId])
  @@index([branchId])
}

// ============================================
// USER ROLES & PERMISSIONS
// ============================================

model UserRole {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  access    String   // Admin, Manager, Branch Manager, User with Privileges
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
}

model UserPrivilege {
  id         String   @id @default(cuid())
  userId     String   @unique
  privileges Json     // Stores UserPrivileges structure
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// BRANCHES & LOCATIONS
// ============================================

model Branch {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  code      String?  @unique
  cityId    Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  city      City?    @relation(fields: [cityId], references: [id])
  employees Employee[]
  projects  Project[]
}

model City {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  countryId Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  country   Country? @relation(fields: [countryId], references: [id])
  branches  Branch[]
  employees Employee[]
}

model Country {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  code      String?  @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cities    City[]
}

model GosiCity {
  id        Int       @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employees Employee[]
}

// ============================================
// EMPLOYEES
// ============================================

model Employee {
  id                Int       @id @default(autoincrement())
  employeeNumber    String?   @unique
  nameEn            String
  nameAr            String?
  email             String?   @unique
  phone             String?
  designationId    Int?
  branchId          Int?
  cityId            Int?
  statusId          Int?
  gosiCityId        Int?
  joiningDate       DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime @updatedAt

  designation       Designation? @relation(fields: [designationId], references: [id])
  branch            Branch?      @relation(fields: [branchId], references: [id])
  city              City?        @relation(fields: [cityId], references: [id])
  status            EmployeeStatus? @relation(fields: [statusId], references: [id])
  gosiCity          GosiCity?    @relation(fields: [gosiCityId], references: [id])
  timesheets        Timesheet[]
  loans             Loan[]
  trafficChallans   TrafficChallan[]
  exitReentries     ExitReentry[]
  payrolls          Payroll[]

  @@index([employeeNumber])
  @@index([email])
  @@index([branchId])
  @@index([statusId])
}

model Designation {
  id        Int       @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employees Employee[]
}

model EmployeeStatus {
  id        Int       @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employees Employee[]
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id          Int      @id @default(autoincrement())
  nameEn      String
  nameAr      String?
  code        String?  @unique
  branchId    Int?
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch      Branch?  @relation(fields: [branchId], references: [id])
  timesheets  Timesheet[]
}

// ============================================
// TIMESHEETS
// ============================================

model Timesheet {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  projectId   Int
  date        DateTime
  hours       Decimal   @db.Decimal(5, 2)
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([projectId])
  @@index([date])
}

// ============================================
// PAYROLL
// ============================================

model Payroll {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  sectionId   Int?
  month       Int       // 1-12
  year        Int
  amount      Decimal   @db.Decimal(10, 2)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  section     PayrollSection? @relation(fields: [sectionId], references: [id])

  @@index([employeeId])
  @@index([year, month])
}

model PayrollSection {
  id        Int      @id @default(autoincrement())
  nameEn    String
  nameAr    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payrolls  Payroll[]
}

// ============================================
// LOANS
// ============================================

model Loan {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  amount      Decimal   @db.Decimal(10, 2)
  startDate   DateTime
  endDate     DateTime?
  status      String    // active, completed, cancelled
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
}

// ============================================
// TRAFFIC CHALLANS
// ============================================

model TrafficChallan {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  amount      Decimal   @db.Decimal(10, 2)
  date        DateTime
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([date])
}

// ============================================
// EXIT & RE-ENTRY
// ============================================

model ExitReentry {
  id          Int       @id @default(autoincrement())
  employeeId  Int
  exitDate    DateTime
  reentryDate DateTime?
  reason      String?   @db.Text
  status      String    // pending, completed, cancelled
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
}

// ============================================
// LEDGER
// ============================================

model Ledger {
  id          Int       @id @default(autoincrement())
  date        DateTime
  description String    @db.Text
  debit       Decimal?  @db.Decimal(10, 2)
  credit      Decimal?  @db.Decimal(10, 2)
  balance     Decimal   @db.Decimal(10, 2)
  reference   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([date])
}
